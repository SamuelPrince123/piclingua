<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Free Speech Recognition Demo</title>
<style>
  body { font-family: Arial, sans-serif; padding: 2rem; background: #f0f0f0; }
  button { padding: 1rem 2rem; font-size: 1.2rem; cursor: pointer; }
  #transcript { margin-top: 1rem; font-size: 1.5rem; background: white; padding: 1rem; border-radius: 8px; min-height: 100px; }
</style>
</head>
<body>

<h1>üéôÔ∏è Free Speech Recognition Demo</h1>
<button id="start-btn">Start Listening</button>

<div id="transcript" placeholder="Your speech will appear here..."></div>

<script>
  window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

  if (!window.SpeechRecognition) {
    alert('Sorry, your browser does not support Speech Recognition API.');
    console.error('SpeechRecognition not supported');
  } else {
    const recognition = new SpeechRecognition();
    recognition.interimResults = true;
    recognition.lang = 'en-US';

    const startBtn = document.getElementById('start-btn');
    const transcriptDiv = document.getElementById('transcript');

    let finalTranscript = '';
    let lastSpokenTime = Date.now();
    let startTimestamp = 0;
    let recognitionStarted = false;

    recognition.addEventListener('start', () => {
      recognitionStarted = true;
      startBtn.disabled = true;
      console.log('[recognition] started');
    });

    recognition.addEventListener('result', e => {
      console.log('[recognition] result event', e);
      lastSpokenTime = Date.now();

      let interim = '';
      for (let i = e.resultIndex; i < e.results.length; i++) {
        const t = e.results[i][0].transcript;
        if (e.results[i].isFinal) {
          finalTranscript += t + ' ';
          console.log('  final transcript updated:', finalTranscript);
        } else {
          interim += t;
          console.log('  interim transcript:', t);
        }
      }
      transcriptDiv.textContent = finalTranscript + interim;
    });

    recognition.addEventListener('error', e => {
      console.error('[recognition] error:', e.error);
      alert('Speech recognition error: ' + e.error);
      startBtn.disabled = false;
      recognitionStarted = false;
    });

    recognition.addEventListener('end', () => {
      console.log('[recognition] end event');
      const elapsed = Date.now() - startTimestamp;
      console.log('  elapsed since start:', elapsed, 'ms');

      // Ignore if recognition never started properly or ended too soon
      if (!recognitionStarted) {
        console.warn('  Ignored end event because recognition never started');
        return;
      }
      if (elapsed < 1000) {
        console.warn('  Ignored premature end event (<1s)');
        return;
      }

      recognitionStarted = false;
      startBtn.disabled = false;

      sendTranscript();
    });

    function sendTranscript() {
      const msg = transcriptDiv.textContent.trim();
      console.log('sendTranscript() with message:', msg);
      if (msg.length === 0) {
        alert('No speech detected. Please try again.');
        return;
      }
      localStorage.setItem('speechTranscript', msg);
      console.log('  saved transcript to localStorage, redirecting...');
      window.location.href = 'AiDeep.html';
    }

    startBtn.addEventListener('click', () => {
      console.log('Start button clicked');
      finalTranscript = '';
      transcriptDiv.textContent = '';
      recognitionStarted = false;
      lastSpokenTime = Date.now();
      startTimestamp = Date.now();
      console.log('  starting recognition at', startTimestamp);

      try {
        recognition.start();
      } catch (err) {
        console.error('recognition.start() error:', err);
        alert('Failed to start recognition: ' + err.message);
        startBtn.disabled = false;
        return;
      }

      // Max 30 seconds timer
      setTimeout(() => {
        if (recognitionStarted) {
          console.log('Max duration reached, stopping recognition');
          recognition.stop();
        }
      }, 30000);

      // Check for 2 seconds silence
      const silenceCheck = setInterval(() => {
        if (!recognitionStarted) {
          clearInterval(silenceCheck);
          return;
        }
        if (Date.now() - lastSpokenTime > 3000) {
          console.log('Detected 2 seconds silence, stopping recognition');
          clearInterval(silenceCheck);
          recognition.stop();
        }
      }, 1000);
    });
  }
</script>

</body>
</html>
